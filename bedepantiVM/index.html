<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-WcJ4duLo3NE/Vw_dP02SvlI/AAAAAAAAFrE/nbjZ6jBuoHMHeiGfA_YXec5rtNGcvTU6ACK4B/s1600/g.jpg" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="138" src="https://3.bp.blogspot.com/-WcJ4duLo3NE/Vw_dP02SvlI/AAAAAAAAFrE/nbjZ6jBuoHMHeiGfA_YXec5rtNGcvTU6ACK4B/s200/g.jpg" width="200" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;"><div style="font-size: 12.8px;">Simulacra &amp; Simulation - Jean Baudrillard</div><div style="font-size: 12.8px;">Featured in Matrix</div></td></tr></tbody></table><div>Bedep could be described as a fileless loader with a resident module that can optionally perform AdFraud. It's intimate to Angler EK and appeared around&nbsp;<a href="http://malware.dontneedcoffee.com/2014/08/angler-ek-now-capable-of-fileless.html">August 2014</a>.&nbsp;</div><div style="text-align: center;"><br /></div><div>On the 2016-03-24 I noticed several move in Bedep.&nbsp;</div><div><br /></div><div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td><a href="http://3.bp.blogspot.com/-abxn9m0x1B4/Vw-RQNM9T8I/AAAAAAAAFpA/_OkOUSFsEtAjFkvnEwIWFrVTJbVR9ZfTACK4B/s1600/2016-04-14_14h44_29.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="190" src="https://3.bp.blogspot.com/-abxn9m0x1B4/Vw-RQNM9T8I/AAAAAAAAFpA/_OkOUSFsEtAjFkvnEwIWFrVTJbVR9ZfTACK4B/s640/2016-04-14_14h44_29.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="font-size: 12.8px;">Angler infecting a VM and integrating it into an instance of Bedep botnet<br />2016-03-24</td></tr></tbody></table></div><div>No more variable in the URI (as several month before), the protocol Key changed and in most of my manual checks, all threads were sending a strange payload in the first stream.</div><div><br /></div><div>2ko size for Win7 64bits :</div><div><span style="background-color: white; color: #333333; font-family: &quot;helvetica neue&quot; , &quot;helvetica&quot; , &quot;arial&quot; , sans-serif; font-size: 13px; line-height: 20px;"><a href="https://www.virustotal.com/file/80eb8a6aba5e6e70fb6c4032242e9ae82ce305d656b4ed8b629b24e1df0aef9a/analysis/1460541070/">80eb8a6aba5e6e70fb6c4032242e9ae82ce305d656b4ed8b629b24e1df0aef9a</a></span></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-go8uU47tUp4/Vw-Grw8lmaI/AAAAAAAAFoQ/7u0wmpvRn0EoZZio5658M6vYtYz7iF0gACK4B/s1600/2016-04-13_19h10_53.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="200" src="https://2.bp.blogspot.com/-go8uU47tUp4/Vw-Grw8lmaI/AAAAAAAAFoQ/7u0wmpvRn0EoZZio5658M6vYtYz7iF0gACK4B/s320/2016-04-13_19h10_53.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Popup shown by the first payload from Bedep Stream - Win7<br />(in the background Angler Landing)</td></tr></tbody></table><div><br /></div><div>48ko size for WinXP 32bits:</div><div><a href="https://www.virustotal.com/file/a0fe4139133ddb62e6db8608696ecdaf5ea6ca79b5e049371a93a83cbcc8e780/analysis/1460550059/">a0fe4139133ddb62e6db8608696ecdaf5ea6ca79b5e049371a93a83cbcc8e780</a></div><div><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-zduDkAoPUWs/Vw-Kzdtvn5I/AAAAAAAAFok/zfoMgypK83oW8fog_opMOX1UYVWC8tJlgCK4B/s1600/2016-03-24_10h43_40.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="102" src="https://2.bp.blogspot.com/-zduDkAoPUWs/Vw-Kzdtvn5I/AAAAAAAAFok/zfoMgypK83oW8fog_opMOX1UYVWC8tJlgCK4B/s320/2016-03-24_10h43_40.png" width="320" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;"><span style="font-size: 12.8px;">Popup shown by the first payload from Bedep Stream - WinXP</span></td></tr></tbody></table><br /><div>Looking at my traffic I thought for some time that one of the Bedep instances was split in two.<br /><div><br /><div>Then I understood that I got different result on my "manually" driven VM (on VMWare ESXi) and my automated Cuckoo driven one ( on VirtualBox). I suspected it was related to hardening, as this is one of the main difference between those two systems.</div><div><br /></div><div>And I got confirmation. Here is an example on a GooNky (<a href="https://www.proofpoint.com/us/threat-insight/post/The-Shadow-Knows">[1]</a> <a href="http://blog.trendmicro.com/trendlabs-security-intelligence/lets-encrypt-now-being-abused-by-malvertisers/">[2]</a> <a href="https://www.proofpoint.com/us/threat-insight/post/video-malvertising-bringing-new-risks-high-profile-sites">[3]</a>) malvertising traffic in Australia :</div><div><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://4.bp.blogspot.com/-sYLcWGrH93w/Vw-XWP46kyI/AAAAAAAAFpY/__6yQRW8SFseb8fWv30nn3_TWefePHO-QCK4B/s1600/2016-04-14_15h09_38.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="176" src="https://4.bp.blogspot.com/-sYLcWGrH93w/Vw-XWP46kyI/AAAAAAAAFpY/__6yQRW8SFseb8fWv30nn3_TWefePHO-QCK4B/s640/2016-04-14_15h09_38.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">A VM not hardened enough against Bedep got redirected to a "decoy" instance of Bedep that i will refer as :<br />Bedep "Robot Town" - 2016-04-12</td></tr></tbody></table><div>Now look what i get instead with a VM that is not spotted as is:</div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-39iVgntzWXU/Vw-YyDozHEI/AAAAAAAAFpk/hlOeVNjR528L5JQ8ZcrPCBO7u1tz09KuACK4B/s1600/2016-04-14_15h18_12.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="118" src="https://1.bp.blogspot.com/-39iVgntzWXU/Vw-YyDozHEI/AAAAAAAAFpk/hlOeVNjR528L5JQ8ZcrPCBO7u1tz09KuACK4B/s640/2016-04-14_15h18_12.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Same Angler thread - VM not detected. 1st Stream get Vawtrak<br />2016-04-12</td></tr></tbody></table><div>(<i><span style="font-size: x-small;">&nbsp;Vawtrak in that stream &nbsp;&nbsp;<a href="https://www.virustotal.com/file/d24674f2f9879ee9cec3eeb49185d4ea6bf555d150b4e840407051192eda1d61/analysis/1460644841/">d24674f2f9879ee9cec3eeb49185d4ea6bf555d150b4e840407051192eda1d61</a> </span></i>)</div><div><br /><br /></div><div>I am not skilled enough to give you the list of checks Bedep is doing. But here is one of them spotted by Cuckoo :</div><div><div><br /></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-geexrcYR9eY/Vw-TJJObZZI/AAAAAAAAFpM/2ahiBNANbwobNdts9mAKlnRnDvsyy0kXACK4B/s1600/2016-04-14_14h54_35.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="112" src="https://1.bp.blogspot.com/-geexrcYR9eY/Vw-TJJObZZI/AAAAAAAAFpM/2ahiBNANbwobNdts9mAKlnRnDvsyy0kXACK4B/s640/2016-04-14_14h54_35.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Bedep doing some ACPI checks</td></tr></tbody></table><div>I think there are multiple level of checks. Some resulting in Bedep not trying to contact the C&amp;C, some where the positive check end up with a different seed for the Bedep DGA redirecting spotted machines in a dedicated instance.&nbsp;</div><div>This is quite powerful :</div><div>- the checks are made without dropping an executable.&nbsp;</div><div>- if you don't know what to expect it's quite difficult to figure out that you have been trapped</div><div>- there is a lot of things that operators can do with this list of known bots and initial Bedep thread ID.&nbsp;</div><div><br /></div><div>One of them is for instance knowing which of the infection path are researcher/bots "highway" :</div><div><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-AlT_p_AlGr4/Vw_HXEzFyPI/AAAAAAAAFqw/OoEO5trWrmkGoeNCf0mKER7vzreZwQ7UwCK4B/s1600/2016-04-14_12h40_05.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="570" src="https://3.bp.blogspot.com/-AlT_p_AlGr4/Vw_HXEzFyPI/AAAAAAAAFqw/OoEO5trWrmkGoeNCf0mKER7vzreZwQ7UwCK4B/s640/2016-04-14_12h40_05.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;"><span style="font-size: 12.8px;">Illustration for Bedep "Robot Town" from an "infection path" focused point of view</span></td></tr></tbody></table></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div><br /></div><div style="text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div>This could be just a move to perform different tasks (AdFraud only (?) ) on VMs, but my guess it that this Bedep evolution on 2016-03-24 is a fast reaction to this <a href="https://www.proofpoint.com/us/threat-insight/post/video-malvertising-bringing-new-risks-high-profile-sites">Proofpoint Blog</a> from 2016-03-18 which &nbsp;show how Bedep threads are additional connectable dots.&nbsp;</div></div><div><br /></div><div>Sharing publicly is often a difficult decision. The question is which side will benefits the most from it, in the long time.</div><div><br /></div><div><u>For researchers:</u></div><div>In the <u>last 3 weeks</u>, if your VM have communicated with :</div><div><div>95.211.205.228 (<i><span style="font-size: x-small;">which is a Bedep ip from end of 2015 reused</span></i>) || ( 85.25.41.95&nbsp; &amp;&amp; http.uri.path &nbsp;"ads.php?sid=<b>1901</b>" ) and you are interested by the "real payload" then you might want to give&nbsp;<a href="https://github.com/a0rtega/pafish">PAfish</a>&nbsp;a run.</div><div class="separator" style="clear: both; text-align: center;"></div><div style="margin-left: 1em; margin-right: 1em;"><br /></div><br /><div class="separator" style="clear: both; text-align: center;"><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><img alt="Image result for robot movie sad robot" height="200" src="http://www.writeups.org/wp-content/uploads/Marvin-Paranoid-Android-Hitchiker-Guide.jpg" style="margin-left: auto; margin-right: auto; text-align: center;" width="126" /></td></tr><tr><td class="tr-caption" style="text-align: center;">Marvin - Paranoid Android</td></tr></tbody></table></div><div>On the other hand, any of your VM which has communicated with 104.193.252.245 (Bedep "standard" 18xx 19xx instance)&nbsp;&nbsp;since the 24 of March&nbsp;is hardened enough to grab the real payload.</div></div><div><br /><span style="font-size: x-small;">[Edits]</span><br /><span style="font-size: x-small;">- Removed the AU focused mention on the Vawtrak. I have been told (Thanks ! ) it's US focused. Got geo&nbsp;</span><br /><span style="font-size: x-small;">Glitched. Maybe more about that a day or the other.</span><br /><span style="font-size: x-small;">- Refine the check conditions for Researcher. IP &nbsp;85.25.41.95 and sid=1901...otherwise...ok :)</span><br /><span style="font-size: x-small;">[/Edits]</span><br /><br /></div><div><u>Acknowledgements :</u></div><div>Thanks <a href="https://twitter.com/node5">Will Metcalf</a> and <a href="https://twitter.com/malc0de">Malc0de</a> for the discussions and help on this topic</div><div>--</div><div>I'm sorry, but I must do it...Greetings to Angler and Bedep guys. ;)&nbsp;You are keeping us busy...and awake !</div><div><br /></div><div><b><u>Reading :</u></b></div><div><a href="https://www.proofpoint.com/us/threat-insight/post/video-malvertising-bringing-new-risks-high-profile-sites">Video Malvertising Bringing New Risks to High-Profile Sites</a> - 2016-03-18 - Proofpoint</div><div><a href="https://www.arbornetworks.com/blog/asert/bedeps-dga-trading-foreign-exchange-for-malware-domains/">Bedepâ€™s DGA: Trading Foreign Exchange for Malware Domains</a> - 2015-04-21 - Dennis Schwarz - ArborSert</div><div><a href="http://malware.dontneedcoffee.com/2014/08/angler-ek-now-capable-of-fileless.html">Angler EK : now capable of "fileless" infection (memory malware)</a> - 2014-08-30</div><div><a href="http://blog.prowling.nu/2012/08/modifying-virtualbox-settings-for.html">Modifying VirtualBox settings for malware analysis</a>&nbsp;- 2012-08-23 &nbsp;-&nbsp;<a href="https://twitter.com/nsmfoo">Mikael Keri</a></div><div><br /></div><div><br /></div></div></div>